+++
title = "H2 - Nmap and metasploit"
date = "2025-09-01"
categories = ["pentesting-course"]
+++

---

### a) Checking kali's and metasploitable2's connections

To check the connections of the two machines, I `ping 8.8.8.8` and `ping terokarvinen.com`. Neither one got callbacks.

![Kali disconnected](/tuukkaani-blog/img/h2/kali_offline.png)

![Metasploitable2 disconnected](img/h2/ms_offline.png)

I acquired both IPs by using `ip a` and then `ping` on each of the addresses. The pings were successful.

![kali's IP](/tuukkaani-blog/img/h2/kali_ipa.png)

![metasploitable's IP](/tuukkaani-blog/img/h2/ms_ipa.png)

![Kali to ms](/tuukkaani-blog/img/h2/kali_to_ms.png)

![Ms to kali](/tuukkaani-blog/img/h2/ms_to_kali.png)

---

### b) Opening up msfconsole

Msfconsole can be opened by using `sudo msfconsole`.

![Msfconsole](/tuukkaani-blog/img/h2/msfconsole.png)

---

### c) Scanning metasploitable2 using db_nmap


I tried `db_nmap -sn` and failed to connect to the database.

![Database not connected](/tuukkaani-blog/img/h2/no_database.png)

This happened due to me forgetting to start the postgresql service with `sudo systemctl start postgresql` and initializing the database with `sudo msfdb init`. I exited the msfconsole, ran the aforementioned commands and tried `sudo msfconsole` again, after which I could `db_nmap -sn` successfully.

![Successful db_nmap](/tuukkaani-blog/img/h2/db_nmap.png)

Lastly I navigated to the Metasploitable2's front page using a browser.

![Metapsloitable2's front page](/tuukkaani-blog/img/h2/frontpage.png)

---

### d) Extensive port scanning and saving the results

First I did a more extensive scan using `db_nmap -T -A -p1-65535 -n 192.168.110.216`. The scanned services can be viewed by using the `services` command.

![Services](/tuukkaani-blog/img/h2/services.png)

Then I repeated the scan, but this time with a couple new flags `nmap -T -A -p1-65535 -n -oA foo 192.168.110.216`. After which three output files could be found in the home directory.

![Foo files](/tuukkaani-blog/img/h2/foo_files.png)

---

### e) Checking out the DB functionality

I checked `hosts --help` and `services --help`. They both have some similar flags for filtering and searching, notably `-S` for searching by a given string and `-c` for showing only specified columns.

Here are the outputs from `services -S vsftpd` and `services -c port,state`.

![services -S results](/tuukkaani-blog/img/h2/services_s.png)

![services -c results](/tuukkaani-blog/img/h2/services_c.png)

---

### f) Comparing the file output and database output pros and cons

#### nmap -oA foo files

Using nmap with `-oA foo` flag made three new files with .nmap .gnmap and .xml file extensions. By using `cat foo.nmap` the output is pretty identical to the nmap's usual . 

![Cat foo.nmap](/tuukkaani-blog/img/h2/foo_snippet.png)

Next up we got the .gnmap file. Output of the file seems to be not as readable as the .nmap file.

![Cat foo.gnmap](/tuukkaani-blog/img/h2/foo_snippet_2.png)

I assume this file is supposed to be used with some sort of parsing tool to make it more useful. The same assumption can be made of the .xml file, which could be given to an external program to parse or log into a larger dataset.

#### db_nmap

The `db_nmap` output is easily readable and can be searched and ordered quite conveniently. It has all the most relevant information in nice columns. For a quick peek inside the terminal window, it is quite nice.

![services -S results](/tuukkaani-blog/img/h2/services_s.png)

#### Why use one over the other?

Even though I think the `db_nmap` output is pretty and convenient for a quick reminder, I do find the files to have their strengths as well. They can easily be used alongside tools like grep and awk to parse through. You can also have just the plain output file open on a separate window and add notes if necessary. I find both useful, but personally I like having independent files to work with... Or writing things down in a notebook.

---

### g) Exploiting the target machine's vsftpd service

First I used msfconsole's `search vsftpd` function to search for modules matching the service I am targeting. I get two options:

![Vsftpd related modules](/tuukkaani-blog/img/h2/vsftpd_search.png)

a DoS related module and a backdoor. I used the backdoor module by typing `use 1`.

![Use module 1](/tuukkaani-blog/img/h2/use_module.png)

The msfconsole defaulted to cmd/unix/interact payload which I will use. Next I need to setup the target address by typing `set RHOST 192.168.110.216`. Lastly, I ran the `exploit` command.

![using ls inside metasploitable2](/tuukkaani-blog/img/h2/inside_ms.png)

The exploit ran successfully and I got inside the target machine and have a usable session.

---

### h) Upgrading the session to meterpreter

Now, I used CTRL+z to background the session and return to the msfconsole.
Using `sessions` I can see I have an active session: session 1. 

![Sessions](/tuukkaani-blog/img/h2/sessions.png)

Next I check the usage page for sessions by typing  `sessions --help`. It has a -u, --upgrade flag that can be used to upgrade a shell to a meterpreter session. I'll use that to upgrade the session `sessions -u 1` and check the sessions again.

![Meterpreter session](/tuukkaani-blog/img/h2/meterpreter_session.png)

After which I can use the newly created meterpreter session with `sessions 2`.

![Meterpreter](/tuukkaani-blog/img/h2/meterpreter.png)

---

### i) Looking for information on possible lateral movements

Inside the target machine I can use the new meterpreter session to run `netstat` to see any network connections the target machine has. In this case, it only finds things relating to the target machine and our Kali machine. 

![Netstat](/tuukkaani-blog/img/h2/netstat.png)

Next I use `arp` to check the ARP cache for recent connections to the machine. The sole connection right now is the Kali machine, but it could be other machines in the target's network.

![ARP](/tuukkaani-blog/img/h2/arp.png)

---

### j) Checking other possible avenues of attack on the target machine

I CTRL+z the meterpreter session for now and return to the msfconsole. I use `services` and check which services I'll try first. After some thinking I decide to go check the website and see what we have. I go through all the links listed and see few login pages and other interesting stuff. I decide to start with the first link TWiki.

#### TWiki

After opening twiki I am greeted with the following page:

![Twiki front page](/tuukkaani-blog/img/h2/twiki.png)

There is a readme file which could be useful. I decide to take a quick look, maybe it has something interesting inside. Surely enough, we can find the version the server is running:

![Twiki readme](/tuukkaani-blog/img/h2/twiki_version.png)

Next up, I use msfconsole's `search twiki` to see if there are anything that we can use for seemingly very out of date service. We get few hits:

![Twiki exploits](/tuukkaani-blog/img/h2/twiki_exploits.png)

I decide to start testing them out. Firstly the one from 2004 *unix/webapp/twiki_search*. After trying few of the payloads, I couldn't get any established connection back home.

Next I tried the exploit from 2005 *unix/webapp/twiki_history*. Once again I had to try couple of times, but I got a successful connection with `set payload cmd/unix/php/meterpreter/reverse_tcp`. I also had some success with `set payload cmd/unix/reverse` and then upgraded the session to meterpreter with `sessions -u 'session id'`.

![Twiki win](/tuukkaani-blog/img/h2/twiki_win.png)

---

### k) Testing out meterpreter's functionality

With the newly established connection to the target machine, I think it is appropriate to test some of the functionality it brings. Just typing `help` gives us some commands to use.

![Meterpreter help](/tuukkaani-blog/img/h2/meterpreter_help.png)

The usual suspects are available to use such as `cat cd cp ls` and so on.
There are also some interesting ones like `download` and `upload`. For getting files out of the system like ssh keys or uploading malicious files.

---

### l) Saving the shell-session to a text file

I open up a second terminal window and use the given command `script -fa log001.txt`.

![Script ok](/tuukkaani-blog/img/h2/script_ok.png)

Then I type few test commands and `exit` the script. I `cat` the new log file and it outputs the shell one to one.

![Ben Stiller](/tuukkaani-blog/img/h2/benstiller.png)

---

### OPT m.) Getting a tty on the target machine

I am currently connected to the target machine and a dumb shell.
Firstly we can check if python is installed on the system with `python -V`

![Python version](/tuukkaani-blog/img/h2/python_version.png)

We can use that to spawn a pseudo terminal by typing `python -c 'import pty; pty.spawn("/bin/bash")'`. The pseudo terminal still lacks functionality though like up and down arrows etc. [(Ropnop 2017.)](https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/#tldr-cheatsheet)

![Nano opened](/tuukkaani-blog/img/h2/nano.png)

*Nano can be opened just fine.*

---

### x) Quick notes on reading material

Jaswal goes over a example scenario where we can familiarize the basic tools metasploit offers. In this example we go from doing recon all the way to post exploit. Exploiting a old windows machine using the EternalBlue exploits. 
The chapter gives a good overview of the workflow one can start getting familiar to when using metasploit. 

[(Jaswal 2020.)](https://learning.oreilly.com/library/view/mastering-metasploit/9781838980078/B15076_01_Final_ASB_ePub.xhtml#_idParaDest-31)

---

### Sources

All the assignments this page is based on can be found at [Tero Karvinen](https://terokarvinen.com/tunkeutumistestaus/)

Ropnop 2017. [Upgrading simple shells to fully interactive TTYs](https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/#tldr-cheatsheet)

Jaswal 2020. [Mastering Metasploit 4th edition. Chapter 1. Approaching A Penetration Test Using Metasploit. Conducting a penetration test with metasploit.](https://learning.oreilly.com/library/view/mastering-metasploit/9781838980078/B15076_01_Final_ASB_ePub.xhtml#_idParaDest-31)
